<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>テトリス完成版</title>
<style>
  body{
    margin:0;background:#2e1e12;display:flex;flex-direction:column;align-items:center;
    font-family:'Helvetica Neue',sans-serif;color:#fff;
  }
  canvas{margin-top:20px;background:#000;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.5);}
  .controls,.character-select,.difficulty-select{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  button{
    padding:10px 15px;border-radius:10px;border:none;font-size:1.1rem;background:#ffe8b6;
    box-shadow:0 4px #ccc;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent;
  }
  button:active{box-shadow:none;transform:translateY(2px)}
  #startBtn{margin-top:20px;font-weight:bold}
  #score,#highscore{margin-top:8px;font-size:1.2rem}
  #characterIcon{position:absolute;top:10px;right:10px;width:55px;height:55px}
  .selected{background:#ffd35b;box-shadow:0 0 0 2px #fff inset}
</style>
</head>
<body>
  <img id="characterIcon" src="mochikuma.png" alt="キャラ">
  <canvas id="game" width="240" height="400"></canvas>

  <button id="startBtn">ゲームスタート</button>
  <div id="score" style="display:none;">スコア: 0</div>
  <div id="highscore" style="display:none;">ハイスコア: 0</div>

  <div class="controls" style="display:none;" id="controls">
    <button id="left">←</button><button id="rotate">↻</button><button id="right">→</button><button id="down">↓</button>
  </div>
  <div class="character-select">
    <button onclick="setTheme('kuma')" id="kumaBtn">もちくま</button>
    <button onclick="setTheme('usagi')" id="usagiBtn">もちうさぎ</button>
    <button onclick="setTheme('kitsune')" id="kitsuneBtn">もちきつね</button>
  </div>
  <div class="difficulty-select">
    <button onclick="setDifficulty('easy')"   id="easyBtn">EASY</button>
    <button onclick="setDifficulty('normal')" id="normalBtn">NORMAL</button>
    <button onclick="setDifficulty('hard')"   id="hardBtn">HARD</button>
  </div>

<script>
/* ---------- 基本定義 ---------- */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const ROWS=20,COLS=12,SIZE=20;
let grid,current,interval;
let score,highscore=+localStorage.getItem("highscore")||0;
let speed=600,blockColor="#ffe8b6";

/* 長押し用タイマー */
let delayT=null, intervalT=null;
function stopRepeat(){ clearTimeout(delayT); clearInterval(intervalT); delayT=intervalT=null; }

const themes={
  kuma:{bg:'#2e1e12',block:'#ffe8b6',img:'mochikuma.png',color:'#fff'},
  usagi:{bg:'#faf4f0',block:'#fca3b7',img:'mochiusagi.png',color:'#000'},
  kitsune:{bg:'#1f1b14',block:'#f2c97d',img:'mochikitsune.png',color:'#fff'}
};
function setTheme(n){
  const t=themes[n];document.body.style.background=t.bg;document.body.style.color=t.color;
  document.getElementById("characterIcon").src=t.img;blockColor=t.block;draw();
}
function setDifficulty(l){
  ['easy','normal','hard'].forEach(x=>document.getElementById(x+'Btn').classList.remove('selected'));
  document.getElementById(l+'Btn').classList.add('selected');
  speed=l==='easy'?1000:l==='hard'?300:600;
  if(interval){clearInterval(interval);interval=setInterval(drop,speed);}
}

/* ---------- ゲーム開始 ---------- */
document.getElementById("startBtn").addEventListener('click',startGame);
function startGame(){
  stopRepeat();                        // 前回の連続入力を解除
  reset();
  document.getElementById("score").style.display="block";
  document.getElementById("highscore").style.display="block";
  document.getElementById("controls").style.display="flex";
  document.getElementById("startBtn").style.display="none";
  document.getElementById("highscore").textContent="ハイスコア: "+highscore;
  interval=setInterval(drop,speed);
}
function reset(){
  grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  score=0;document.getElementById("score").textContent="スコア: 0";
  current=spawn();draw();
}

/* ---------- ピース定義 ---------- */
const shapes=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
function spawn(){return{shape:shapes[Math.floor(Math.random()*shapes.length)],x:4,y:0};}

/* ---------- 描画 ---------- */
function drawBlock(x,y,c){ctx.fillStyle=c;ctx.fillRect(x,y,SIZE,SIZE);ctx.strokeStyle="#222";ctx.strokeRect(x,y,SIZE,SIZE);}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)if(grid[y][x])drawBlock(x*SIZE,y*SIZE,blockColor);
  current.shape.forEach((row,dy)=>row.forEach((v,dx)=>v&&drawBlock((current.x+dx)*SIZE,(current.y+dy)*SIZE,blockColor)));
}

/* ---------- ロジック ---------- */
function collide(x,y,s){return s.some((row,dy)=>row.some((v,dx)=>v&&(y+dy>=ROWS||x+dx<0||x+dx>=COLS||grid[y+dy]?.[x+dx])));}
function merge(){current.shape.forEach((r,dy)=>r.forEach((v,dx)=>v&&(grid[current.y+dy][current.x+dx]=1)));}
function clearLines(){
  let lines = 0;
  grid = grid.filter(r=>{
    if (r.every(v=>v)) { lines++; return false; }  // 1行そろったら除外
    return true;
  });
  while (grid.length < ROWS) grid.unshift(Array(COLS).fill(0));
  if(lines){
    score += lines * 100;
    document.getElementById("score").textContent="スコア: "+score;
    if(score>highscore){
      highscore=score;localStorage.setItem("highscore",score);
      document.getElementById("highscore").textContent="ハイスコア: "+score;
    }
  }
}
function move(d){if(!collide(current.x+d,current.y,current.shape)){current.x+=d;draw();}}
function rotate(){
  const r=current.shape[0].map((_,i)=>current.shape.map(row=>row[i]).reverse());
  if(!collide(current.x,current.y,r)){current.shape=r;draw();}
}
function drop(){
  if(!collide(current.x,current.y+1,current.shape)){current.y++;}
  else{
    merge();clearLines();current=spawn();
    if(collide(current.x,current.y,current.shape)){gameOver();return;}
  }
  draw();
}
function gameOver(){
  clearInterval(interval);
  stopRepeat();
  alert("ゲームオーバー！");
  document.getElementById("controls").style.display="none";
  document.getElementById("score").style.display="none";
  document.getElementById("highscore").style.display="none";
  document.getElementById("startBtn").style.display="inline-block";
}

/* ---------- 長押しオートリピート ---------- */
const repeatDelay=150, repeatEvery=80;
function bindControl(btn,onPress){
  const startRepeat = ()=>{
    delayT=setTimeout(()=>{intervalT=setInterval(onPress,repeatEvery);},repeatDelay);
  };
  btn.addEventListener('pointerdown',e=>{
    e.preventDefault(); stopRepeat(); onPress(); startRepeat();
  });
  ['pointerup','pointercancel','pointerleave'].forEach(ev=>btn.addEventListener(ev,stopRepeat));
}
bindControl(document.getElementById("left"), ()=>move(-1));
bindControl(document.getElementById("right"),()=>move( 1));
bindControl(document.getElementById("down"), ()=>drop());
bindControl(document.getElementById("rotate"),()=>rotate());

/* ---------- キーボード操作 ---------- */
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft')move(-1);
  else if(e.key==='ArrowRight')move(1);
  else if(e.key==='ArrowDown')drop();
  else if(e.key==='ArrowUp'||e.key==='x')rotate();
  else if(e.key==='Enter'&&document.getElementById("startBtn").style.display!=="none")startGame();
});

/* ---------- 初期化 ---------- */
setTheme('kuma');setDifficulty('normal');
</script>
</body>
</html>
